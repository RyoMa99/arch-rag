# 運用監視

RAGシステムの安定運用のための監視設計。

## メトリクス

### 検索パイプライン

| メトリクス | 説明 | 警告閾値 | 危険閾値 |
|-----------|------|---------|---------|
| レイテンシ（P50） | 50パーセンタイル応答時間 | 2秒 | 5秒 |
| レイテンシ（P95） | 95パーセンタイル応答時間 | 5秒 | 10秒 |
| レイテンシ（P99） | 99パーセンタイル応答時間 | 10秒 | 30秒 |
| エラー率 | リクエストに対するエラーの割合 | 1% | 5% |
| キャッシュヒット率 | Semantic Cacheのヒット率 | < 10% | < 5% |
| 回答不可率 | 「回答不可」で終了した割合 | 5% | 10% |

### インデックス

| メトリクス | 説明 | 警告閾値 | 危険閾値 |
|-----------|------|---------|---------|
| インデックスサイズ | ベクトル数 | - | ディスク90%超 |
| インデックス断片化率 | 削除済みベクトルの割合 | 20% | 40% |
| 埋め込み生成レイテンシ | 1チャンクあたりの処理時間 | 500ms | 1秒 |
| 更新キュー深度 | 未処理の更新リクエスト数 | 1000件 | 5000件 |

### 外部サービス

| メトリクス | 説明 | 警告閾値 | 危険閾値 |
|-----------|------|---------|---------|
| LLM API レイテンシ | GPT/Claude等の応答時間 | 5秒 | 15秒 |
| LLM API エラー率 | API呼び出しの失敗率 | 1% | 5% |
| ベクトルDB レイテンシ | 検索クエリの応答時間 | 100ms | 500ms |
| ベクトルDB 接続数 | アクティブ接続数 | 80% | 95% |

## アラート条件

### 即時対応（Critical）

| 条件 | アクション |
|------|-----------|
| エラー率 > 5%（5分間） | オンコール呼び出し |
| ベクトルDB接続不可 | オンコール呼び出し |
| LLM API全断 | オンコール呼び出し、フォールバック確認 |
| ディスク使用率 > 95% | オンコール呼び出し |

### 要確認（Warning）

| 条件 | アクション |
|------|-----------|
| レイテンシP95 > 5秒（10分間） | Slack通知、翌営業日対応 |
| キャッシュヒット率 < 10%（1時間） | Slack通知、キャッシュ設定確認 |
| 回答不可率 > 5%（1時間） | Slack通知、クエリ分析 |
| 更新キュー深度 > 1000（30分間） | Slack通知、バッチ処理確認 |

## ダッシュボード

### リアルタイムダッシュボード

- リクエスト数/分
- レイテンシ分布（P50/P95/P99）
- エラー率推移
- アクティブユーザー数

### 日次レポート

- 総リクエスト数
- ユニークユーザー数
- 回答品質スコア（RAGAS平均）
- コスト（LLM API使用量）
- Top 10 失敗クエリ

### 週次レポート

- トレンド分析（リクエスト数、エラー率）
- インデックスサイズ推移
- フィードバック集計（Good/Bad比率）
- 改善提案

## ログ設計

### 必須ログフィールド

```json
{
  "timestamp": "ISO8601",
  "request_id": "UUID",
  "user_id": "string",
  "query": "string（PII除去済み）",
  "route": "vector_search|web_search|direct_answer",
  "latency_ms": "number",
  "status": "success|error|fallback",
  "error_type": "string（エラー時）",
  "retrieval_count": "number",
  "rerank_count": "number",
  "cache_hit": "boolean"
}
```

### ログレベル

| レベル | 用途 |
|--------|------|
| ERROR | 処理失敗、要対応 |
| WARN | 性能劣化、閾値超過 |
| INFO | 正常なリクエスト処理 |
| DEBUG | 詳細なデバッグ情報（本番では無効） |

## ツール

| カテゴリ | 推奨ツール |
|---------|-----------|
| 評価・トレーシング | Langfuse |
| メトリクス | Prometheus + Grafana |
| ログ | Elasticsearch + Kibana / Loki |
| アラート | PagerDuty / Opsgenie |
