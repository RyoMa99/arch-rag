# RAGシステム アーキテクチャ設計

LangGraphで実装する運用向けRAGシステムのアーキテクチャ設計ドキュメント。

## 概要

本システムは3つの主要パイプラインで構成される。

## パイプライン一覧

| パイプライン | ドキュメント | 説明 |
|-------------|-------------|------|
| 検索パイプライン | [query-pipeline.md](./query-pipeline.md) | ユーザークエリを処理し、関連ドキュメントを検索して回答を生成 |
| インデックス作成パイプライン | [indexing-pipeline.md](./indexing-pipeline.md) | ドキュメントをチャンク化、ベクトル化してインデックスに登録 |
| 更新パイプライン | [update-pipeline.md](./update-pipeline.md) | 既存インデックスの更新、ゴーストデータ削除、ホット/コールド移行 |

## 運用ドキュメント

| ドキュメント | 説明 |
|-------------|------|
| [operations.md](./operations.md) | 監視メトリクス、アラート条件、ダッシュボード設計 |

## SLA/SLO

### 可用性

| 項目 | 目標 |
|------|------|
| 月間稼働率 | 99.5%（月間ダウンタイム: 約3.6時間以内） |
| 計画メンテナンス | 月1回、最大2時間（事前通知必須） |

### レイテンシ（検索パイプライン）

| パーセンタイル | 目標 | 備考 |
|---------------|------|------|
| P50 | 2秒以内 | 通常リクエストの半数 |
| P95 | 5秒以内 | ほとんどのリクエスト |
| P99 | 10秒以内 | 極端なケースを除く |

※ 複雑なクエリ（HyDE使用、Web検索フォールバック）は上記を超える場合あり

### スループット

| 項目 | 目標 |
|------|------|
| 同時リクエスト | 100 req/s |
| 日間リクエスト | 最大500万件 |

### エラーバジェット

| 項目 | 許容範囲 |
|------|---------|
| エラー率 | 月間 0.5% 以内 |
| 「回答不可」率 | 月間 5% 以内 |

※ エラーバジェット超過時はリリース凍結、安定化優先

## スケーラビリティ

### 水平スケーリング

| コンポーネント | スケーリング方式 | 備考 |
|---------------|-----------------|------|
| 検索パイプライン | ステートレス、Pod数で調整 | K8s HPA推奨 |
| 埋め込み生成 | ワーカー数で調整 | GPU利用時は垂直スケーリングも検討 |
| ベクトルDB（Qdrant） | シャーディング | コレクション単位で分散 |
| 全文検索（Elasticsearch） | シャード分割 | インデックス設計時に考慮 |

### キャパシティプランニング

| 規模 | ドキュメント数 | 推奨構成 |
|------|--------------|---------|
| Small | 〜10万件 | 単一ノード、IndexFlatIP |
| Medium | 10万〜100万件 | Qdrant 3ノード、HNSW |
| Large | 100万件〜 | Qdrant シャーディング、専用GPU |

### ボトルネックと対策

| ボトルネック | 症状 | 対策 |
|-------------|------|------|
| LLM API | レイテンシ増大、レート制限 | Semantic Cache強化、バッチ処理 |
| ベクトル検索 | 検索レイテンシ増大 | インデックス最適化、シャーディング |
| 埋め込み生成 | 更新キュー滞留 | ワーカー増、GPUインスタンス |
| メモリ | OOM発生 | チャンクサイズ縮小、バッチサイズ調整 |

### コスト最適化

| 項目 | 対策 |
|------|------|
| LLM API費用 | Semantic Cache、小モデルでのプレフィルタ |
| 埋め込み費用 | 増分更新、変更チャンクのみ再生成 |
| インフラ費用 | スポットインスタンス（バッチ処理）、オートスケーリング |
| ストレージ費用 | 古いインデックスの定期削除、圧縮 |

## 技術スタック（参考）

| カテゴリ | 推奨技術 |
|---------|---------|
| フレームワーク | LangGraph |
| 埋め込みモデル | ruri-v3-310m（日本語特化、JMTEBでSOTA） |
| ベクトルDB | Qdrant / Weaviate |
| 全文検索 | Elasticsearch (BM25) |
| Reranker | TBD |
| 評価 | RAGAS + Langfuse |
